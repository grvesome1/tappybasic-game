# built by grues√∏me
# sig (xor5a): 0x382f33362e7a38237a3d282f3f29a2373f

name: ci

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: arcade-integration-kit

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: arcade-integration-kit/package-lock.json

      - name: Install
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

      - name: Validate Deployment Manifests
        run: npm run manifests:validate

      - name: Validate Watermarks
        run: npm run watermarks:validate

      - name: Compile
        run: npx hardhat compile

      - name: Export ABIs
        run: npm run abis:export

      - name: Ensure Generated ABIs Are Committed
        run: git diff --exit-code

      - name: Build SDK
        run: npm -w packages/arcade-contracts-sdk run build

      - name: Validate EIP-712 Vectors
        run: npm run eip712:vectors:validate

      - name: Build Backend Kit
        run: npm -w packages/arcade-backend-kit run build

      - name: Test Backend Kit
        run: npm -w packages/arcade-backend-kit run test

      - name: Offline Smoke Integration
        run: npm run smoke:offline

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arcade-integration-kit
          if-no-files-found: error
          path: |
            arcade-integration-kit/deployments/*.json
            arcade-integration-kit/packages/*/dist/**
